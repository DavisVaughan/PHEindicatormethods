---
title: "Calculating DSRs using PHEstatmethods"
author: "Georgina Anderson"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    css: style.css
vignette: >
  %\VignetteIndexEntry{Vignette for calculating DSRs for multiple geographies and time periods using data from the Data Lake}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  error = TRUE,
  comment = "#>"
)
```

##DRAFT - Work in Progress



## Introduction
This vignette documents the method for calculating DSRs using the PHEstatmethods::phe_dsr function 
which calculates DSRs and their confidence limits using the Dobson method.


The function can be used to calculate DSRs for grouping single or multiple geographic areas/ genders/ timeperiods/ indicators in a single execution and takes the following arguments as inputs:


| Argument  | Type            | Definition                                                                |Default value  |
|:----------|:----------------|:--------------------------------------------------------------------------|:--------------|
| data      | data.frame      | the data to be standardised                                               | none          |
| x         | numeric vector  | observed number of events for each standardisation category (eg ageband) within each grouping set (eg area or indicator)    | none          |
| n         | numeric vector  | populations for each standardisation category (eg ageband) within each grouping set (eg area or indicator)| none          |
| stdpop    | numeric vector  | standard populations for each standardisation category (eg age band) the European Standard Population 2013 divided into 19 five-year agebands (0-4, 5-9, 10-14, .....90+) is available within the package and can be referenced using esp2013   | none          | 
| conf.level| numeric value   | the required level of confidence expressed as a number between 0.9 and 1 or 90 and 100  | 0.95          |
| multiplier| numeric value   | the multiplier used to express the final values (eg 100,000 = rate per 100,000, 100 = percentage)                          | 100,000       |


If multiple DSRs are required from a single data frame then the data frame must be grouped prior to inputting to the function - this is demonstrated below 


#### The following packages must be installed and loaded if not already available

```{r libraries, message=FALSE}
library(PHEstatmethods)
library(RODBC)
library(dplyr)
library(tidyr)
```


## First let's extract some data to play with

#### Define Connections to Data Lake
```{r define connection}
dbhandle1 <- odbcDriverConnect('driver={SQL Server};server=SQLClusColLake\\Lake;
database=z_Populations_DEV;Encrypt=true;trusted_connection=true')
dbhandle2 <- odbcDriverConnect('driver={SQL Server};server=SQLClusColLake\\Lake;
database=BirthsDeaths;Encrypt=true;trusted_connection=true')
```

#### Execute SQL queries and save results to R data frames
```{r Execute SQL Query and load results into r object}
pops <- sqlQuery(dbhandle1,"SELECT Period, OfficialCode as RGN09CD, GeoName as RGN09NM, 
QuinaryAgeBandMin as AgeBand, Population
FROM [z_Populations_DEV].[dbo].[vRes_RGN09_FiveYear]
WHERE OfficialCode in ('E12000001','E12000002','E12000003')
AND Period in ('2014','2015','2016')
AND Sex = 4
ORDER BY Period, OfficialCode, Sex, QuinaryAgeBandMin")

deaths <- sqlQuery(dbhandle2,"SELECT xYEAR as Period, RGN09CD, RGN09NM, 
       CASE WHEN xAge_Year>=90 THEN 90 ELSE FLOOR(CAST(LEFT(xAge_Year,2) AS FLOAT)/5)*5 END AS AgeBand, COUNT(*) AS Dths
FROM BirthsDeaths.dbo.vDeathsALL d
LEFT JOIN LookupsShared.dbo.vLKP_RGN09 l
ON d.GOR_Resi = l.RGN09CDO 
WHERE RGN09CD IN ('E12000001','E12000002','E12000003')
AND xYEAR in ('2014','2015','2016')
GROUP BY xYEAR, RGN09CD, RGN09NM, 
       CASE WHEN xAge_Year>=90 THEN 90 ELSE FLOOR(CAST(LEFT(xAge_Year,2) AS FLOAT)/5)*5 END
ORDER BY xYear, RGN09CD, AgeBand")
```

#### Close Data Lake Connections
```{r Close dbhandle}
odbcClose(dbhandle1)
odbcClose(dbhandle2)
```


## Now we want to calculate a DSR for each period and geography combination

#### Prepare the data frame

First we'll need to join our datasets to create the input data.frame for the function and specify the grouping sets:

``` {r create reference column}
df <- left_join(pops,deaths, by = c("Period","RGN09CD","RGN09NM","AgeBand")) %>%
      group_by(Period, RGN09CD)
```
 

#### Validate the data frame


We'll be using the esp2013 vector that is provided with the PHEstatmethods package for the stadard population -
it contains 19 ordered values representing the 5-year age bands 0-4, 5-9, 10-14....90+.
Our dataframe must also contain records for the same age bands in the same order for each grouping set
<br />
<span style="color:red">GA note - data is fine but need to re-code this check</span>


``` {r check repeats of stdpop}
all.equal(select(df,1,2,4)[3],
          data.frame(rep(c(0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90),times=9)),
          check.attributes=FALSE, check.names=FALSE)
```


#### Execute the function
 
Now we're ready to calculate the DSRs.  

By default the function will apply 95% confidence, a 100,000 multiplier and will output just 3 fields against each grouping set - the dsr and the lower and upper confidence limits: 
 
``` {r calculate DSRs}
phe_dsr(df, Dths, Population, esp2013)

```

Alternatively, we can add further arguments to specify the level of detail required in the output, the confidence level and the multiplier:

``` {r alternative dsr}
phe_dsr(df, Dths, Population, esp2013, "full", 99.8, 10000)
```


## But what if the data are not so tidy?

#### Zero deaths for a specific age band within a small geography
This would be a fairly common scenario - maybe you have Local Authority data and there are no deaths in some of the younger age groups for some of the smaller areas.  

Let's fudge a couple of data frames to represent this.  In this example, there are no deaths in the 10-14, 15-20 and 20-14 age bands:

``` {r test data}
pops_nodths   <- data.frame(AgeBand    = c( 0, 5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90),
                            Population = c(30,35,35,35,40,40,45,50,50,50,60,60,70,75,70,60,20,20,15))

deaths_nodths <- data.frame(AgeBand = c(0,5,25,30,35,40,45,50,55,60,65,70,75,80,85,90),
                            Dths    = c(1,1, 1, 1, 3, 3, 3, 3,10,10,10,10, 8, 8, 8, 8))
```

If we simply join these data frames to produce the required input data frame then we get NA values in the Deaths column and the function will return an error:

``` {r error test}
data_nodths <- left_join(pops_nodths, deaths_nodths, by="AgeBand")
phe_dsr(data_nodths, Dths, Population, esp2013)
```

The NA values must be replaced with zeros before executing the function: 

``` {r prep data}
data_nodths <- data_nodths %>%
               mutate(Dths = replace(Dths, which(is.na(Dths)), 0))
phe_dsr(data_nodths, Dths, Population, esp2013)
```
