lowerclexact = qchisq((1-0.95)/2,2*obs)/2/exp*10,
upperclexact = qchisq(0.95+(1-0.95)/2,2*obs+2)/2/exp*100) %>%
mutate(method = "Byars") %>%
select(method, groupref, obs, exp, isr, lowerclbyars, upperclbyars, lowerclexact, upperclexact)
View(phe_isr)
phe_isr <- data.frame(x=multiareadata$count,
n=multiareadata$pop,
ref_x=refdata$refcount,
ref_n=refdata$refpop,
groupref=multiareadata$area) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100,
lowerclbyars = byars_lower(obs,0.95)/exp*100,
upperclbyars = byars_upper(obs,0.95)/exp*100,
lowerclexact = qchisq((1-0.95)/2,2*obs)/2/exp*100,
upperclexact = qchisq(0.95+(1-0.95)/2,2*obs+2)/2/exp*100) %>%
mutate(method = "Byars") %>%
select(method, groupref, obs, exp, isr, lowerclbyars, upperclbyars, lowerclexact, upperclexact)
View(phe_isr)
phe_isr <- data.frame(x=multiareadata$count,
n=multiareadata$pop,
ref_x=refdata$refcount,
ref_n=refdata$refpop,
groupref=multiareadata$area) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100,
lowerclbyars = byars_lower(obs,0.95),
upperclbyars = byars_upper(obs,0.95),
lowerclexact = qchisq((1-0.95)/2,2*obs)/2,
upperclexact = qchisq(0.95+(1-0.95)/2,2*obs+2)/2) %>%
mutate(method = "Byars") %>%
select(method, groupref, obs, exp, isr, lowerclbyars, upperclbyars, lowerclexact, upperclexact)
View(phe_isr)
phe_isr <- data.frame(x=multiareadata$count,
n=multiareadata$pop,
ref_x=refdata$refcount,
ref_n=refdata$refpop,
groupref=multiareadata$area) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100,
lowerclbyars = byars_lower(obs,0.95)/exp*100,
upperclbyars = byars_upper(obs,0.95)/exp*100,
lowerclexact = qchisq((1-0.95)/2,2*obs)/2/exp*100,
upperclexact = qchisq(0.95+(1-0.95)/2,2*obs+2)/2/exp*100) %>%
mutate(method = "Byars") %>%
select(method, groupref, obs, exp, isr, lowerclbyars, upperclbyars, lowerclexact, upperclexact)
View(phe_isr)
phe_isr <- function(x,n,ref_x, ref_n, groupref = 1, conf.level = 0.95, percentage = FALSE) {
# scale confidence level
if (conf.level >= 90) {
conf.level <- conf.level/100
}
# calculate ISR and CIs
phe_isr <- data.frame(x,n,ref_x,ref_n,groupref) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100,
lowerclbyars = byars_lower(obs,0.95)/exp*100,
upperclbyars = byars_upper(obs,0.95)/exp*100,
lowerclexact = qchisq((1-conf.level)/2,2*obs)/2/exp*100,
upperclexact = qchisq(conf.level+(1-conf.level)/2,2*obs+2)/2/exp*100) %>%
mutate(method = "Byars") %>%
select(method, groupref, obs, exp, isr, lowercl, uppercl, lowerclexact, upperclexact)
#  names(phe_dsr) <- c("method", "group", "total_count", "total_pop", "dsr",
#                      paste("lower",conf.level*100,"cl",sep=""),
#                      paste("upper",conf.level*100,"cl",sep=""))
return(phe_isr)
}
phe_isr(multiareadata$count, multiareadata$pop,
refdata$refcount, refdata$refpop,
groupref=multiareadata$area)[2:7]
phe_isr <- function(x,n,ref_x, ref_n, groupref = 1, conf.level = 0.95, percentage = FALSE) {
# scale confidence level
if (conf.level >= 90) {
conf.level <- conf.level/100
}
# calculate ISR and CIs
phe_isr <- data.frame(x,n,ref_x,ref_n,groupref) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100,
lowerclbyars = byars_lower(obs,0.95)/exp*100,
upperclbyars = byars_upper(obs,0.95)/exp*100,
lowerclexact = qchisq((1-conf.level)/2,2*obs)/2/exp*100,
upperclexact = qchisq(conf.level+(1-conf.level)/2,2*obs+2)/2/exp*100) %>%
mutate(method = "Byars") %>%
select(method, groupref, obs, exp, isr, lowerclbyars, upperclbyars, lowerclexact, upperclexact)
#  names(phe_dsr) <- c("method", "group", "total_count", "total_pop", "dsr",
#                      paste("lower",conf.level*100,"cl",sep=""),
#                      paste("upper",conf.level*100,"cl",sep=""))
return(phe_isr)
}
phe_isr(multiareadata$count, multiareadata$pop,
refdata$refcount, refdata$refpop,
groupref=multiareadata$area)[2:7]
select(testdata_results,1:6)
phe_isr(multiareadata$count, multiareadata$pop,
refdata$refcount, refdata$refpop,
groupref=multiareadata$area)[2:9]
select(testdata_results,1:6)
phe_isr <- data.frame(x=multiareadata$count,
n=multiareadata$pop,
ref_x=refdata$refcount,
ref_n=refdata$refpop,
groupref=multiareadata$area) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100) %>%
#          lowerclbyars = byars_lower(obs,0.95)/exp*100,
#          upperclbyars = byars_upper(obs,0.95)/exp*100,
#          lowerclexact = qchisq((1-0.95)/2,2*obs)/2/exp*100,
#          upperclexact = qchisq(0.95+(1-0.95)/2,2*obs+2)/2/exp*100) %>%
mutate(testlower = ifelse(obs<10), qchisq((1-conf.level)/2,2*obs)/2/exp*100,
ifelse(obs>=10),byars_lower(obs,0.95)/exp*100) %>%
mutate(method = "Byars")
phe_isr <- data.frame(x=multiareadata$count,
n=multiareadata$pop,
ref_x=refdata$refcount,
ref_n=refdata$refpop,
groupref=multiareadata$area) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100) %>%
#          lowerclbyars = byars_lower(obs,0.95)/exp*100,
#          upperclbyars = byars_upper(obs,0.95)/exp*100,
#          lowerclexact = qchisq((1-0.95)/2,2*obs)/2/exp*100,
#          upperclexact = qchisq(0.95+(1-0.95)/2,2*obs+2)/2/exp*100) %>%
mutate(testlower = ifelse(obs<10), qchisq((1-conf.level)/2,2*obs)/2/exp*100,
ifelse(obs>=10),byars_lower(obs,0.95)/exp*100)
?mutate
phe_isr <- data.frame(x=multiareadata$count,
n=multiareadata$pop,
ref_x=refdata$refcount,
ref_n=refdata$refpop,
groupref=multiareadata$area) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100) %>%
#          lowerclbyars = byars_lower(obs,0.95)/exp*100,
#          upperclbyars = byars_upper(obs,0.95)/exp*100,
#          lowerclexact = qchisq((1-0.95)/2,2*obs)/2/exp*100,
#          upperclexact = qchisq(0.95+(1-0.95)/2,2*obs+2)/2/exp*100) %>%
mutate(testlower = if_else(obs<10, qchisq((1-conf.level)/2,2*obs)/2/exp*100,
byars_lower(obs,0.95)/exp*100)) %>%
mutate(method = "Byars")
phe_isr <- data.frame(x=multiareadata$count,
n=multiareadata$pop,
ref_x=refdata$refcount,
ref_n=refdata$refpop,
groupref=multiareadata$area) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100) %>%
#          lowerclbyars = byars_lower(obs,0.95)/exp*100,
#          upperclbyars = byars_upper(obs,0.95)/exp*100,
#          lowerclexact = qchisq((1-0.95)/2,2*obs)/2/exp*100,
#          upperclexact = qchisq(0.95+(1-0.95)/2,2*obs+2)/2/exp*100) %>%
mutate(testlower = if_else(obs<10, qchisq((1-0.95)/2,2*obs)/2/exp*100,
byars_lower(obs,0.95)/exp*100)) %>%
mutate(method = "Byars")
View(phe_isr)
View(phe_isr)
View(phe_isr)
qchisq((1-0.95)/2,2*91)/2/868.5015174865*100
byars_lower(91,0.95)/  868.5015174865*100
phe_isr <- data.frame(x=multiareadata$count,
n=multiareadata$pop,
ref_x=refdata$refcount,
ref_n=refdata$refpop,
groupref=multiareadata$area) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100) %>%
#          lowerclbyars = byars_lower(obs,0.95)/exp*100,
#          upperclbyars = byars_upper(obs,0.95)/exp*100,
#          lowerclexact = qchisq((1-0.95)/2,2*obs)/2/exp*100,
#          upperclexact = qchisq(0.95+(1-0.95)/2,2*obs+2)/2/exp*100) %>%
mutate(testlower = if_else(obs<100, qchisq((1-0.95)/2,2*obs)/2/exp*100,
byars_lower(obs,0.95)/exp*100)) %>%
mutate(method = "Byars")
View(phe_isr)
phe_isr <- function(x,n,ref_x, ref_n, groupref = 1, conf.level = 0.95, percentage = FALSE) {
# scale confidence level
if (conf.level >= 90) {
conf.level <- conf.level/100
}
# calculate ISR and CIs
phe_isr <- data.frame(x,n,ref_x,ref_n,groupref) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100) %>%
#            lowerclbyars = byars_lower(obs,0.95)/exp*100,
#            upperclbyars = byars_upper(obs,0.95)/exp*100,
#            lowerclexact = qchisq((1-conf.level)/2,2*obs)/2/exp*100,
#            upperclexact = qchisq(conf.level+(1-conf.level)/2,2*obs+2)/2/exp*100) %>%
mutate(testlower = if_else(obs<100, qchisq((1-conf.level)/2,2*obs)/2/exp*100,
byars_lower(obs,conf.level)/exp*100)) %>%
mutate(method = if_else(obs<100,"Byars","Exact"))
#  names(phe_dsr) <- c("method", "group", "total_count", "total_pop", "dsr",
#                      paste("lower",conf.level*100,"cl",sep=""),
#                      paste("upper",conf.level*100,"cl",sep=""))
return(phe_isr)
}
phe_isr(multiareadata$count, multiareadata$pop,
refdata$refcount, refdata$refpop,
groupref=multiareadata$area)[2:7]
select(testdata_results,1:6)
phe_isr(multiareadata$count, multiareadata$pop,
refdata$refcount, refdata$refpop,
groupref=multiareadata$area)
phe_isr <- function(x,n,ref_x, ref_n, groupref = 1, conf.level = 0.95, percentage = FALSE) {
# scale confidence level
if (conf.level >= 90) {
conf.level <- conf.level/100
}
# calculate ISR and CIs
phe_isr <- data.frame(x,n,ref_x,ref_n,groupref) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100) %>%
#            lowerclbyars = byars_lower(obs,0.95)/exp*100,
#            upperclbyars = byars_upper(obs,0.95)/exp*100,
#            lowerclexact = qchisq((1-conf.level)/2,2*obs)/2/exp*100,
#            upperclexact = qchisq(conf.level+(1-conf.level)/2,2*obs+2)/2/exp*100) %>%
mutate(testlower = if_else(obs<100, qchisq((1-conf.level)/2,2*obs)/2/exp*100,
byars_lower(obs,conf.level)/exp*100),
testupper = if_else(obs<100, qchisq(conf.level+(1-conf.level)/2,2*obs+2)/2/exp*100,
byars_upper(obs,conf.level)/exp*100),
method = if_else(obs<100,"Byars","Exact"))
#  names(phe_dsr) <- c("method", "group", "total_count", "total_pop", "dsr",
#                      paste("lower",conf.level*100,"cl",sep=""),
#                      paste("upper",conf.level*100,"cl",sep=""))
return(phe_isr)
}
phe_isr(multiareadata$count, multiareadata$pop,
refdata$refcount, refdata$refpop,
groupref=multiareadata$area)
select(testdata_results,1:6)
phe_isr <- function(x,n,ref_x, ref_n, groupref = 1, conf.level = 0.95, percentage = FALSE) {
# scale confidence level
if (conf.level >= 90) {
conf.level <- conf.level/100
}
# calculate ISR and CIs
phe_isr <- data.frame(x,n,ref_x,ref_n,groupref) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100) %>%
#            lowerclbyars = byars_lower(obs,0.95)/exp*100,
#            upperclbyars = byars_upper(obs,0.95)/exp*100,
#            lowerclexact = qchisq((1-conf.level)/2,2*obs)/2/exp*100,
#            upperclexact = qchisq(conf.level+(1-conf.level)/2,2*obs+2)/2/exp*100) %>%
mutate(testlower = if_else(obs<100, qchisq((1-conf.level)/2,2*obs)/2/exp*100,
byars_lower(obs,conf.level)/exp*100),
testupper = if_else(obs<100, qchisq(conf.level+(1-conf.level)/2,2*obs+2)/2/exp*100,
byars_upper(obs,conf.level)/exp*100),
method = if_else(obs<100,"Exact","Byars")) %>%
select(method,everything())
#  names(phe_isr) <- c("method", "group", "total_count", "total_pop", "dsr",
#                      paste("lower",conf.level*100,"cl",sep=""),
#                      paste("upper",conf.level*100,"cl",sep=""))
return(phe_isr)
}
phe_isr(multiareadata$count, multiareadata$pop,
refdata$refcount, refdata$refpop,
groupref=multiareadata$area)
phe_isr <- function(x,n,ref_x, ref_n, groupref = 1, conf.level = 0.95, percentage = FALSE) {
# scale confidence level
if (conf.level >= 90) {
conf.level <- conf.level/100
}
# calculate ISR and CIs
phe_isr <- data.frame(x,n,ref_x,ref_n,groupref) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100) %>%
#            lowerclbyars = byars_lower(obs,0.95)/exp*100,
#            upperclbyars = byars_upper(obs,0.95)/exp*100,
#            lowerclexact = qchisq((1-conf.level)/2,2*obs)/2/exp*100,
#            upperclexact = qchisq(conf.level+(1-conf.level)/2,2*obs+2)/2/exp*100) %>%
mutate(testlower = if_else(obs<100, qchisq((1-conf.level)/2,2*obs)/2/exp*100,
byars_lower(obs,conf.level)/exp*100),
testupper = if_else(obs<100, qchisq(conf.level+(1-conf.level)/2,2*obs+2)/2/exp*100,
byars_upper(obs,conf.level)/exp*100),
method = if_else(obs<100,"Exact","Byars")) %>%
select(method,everything()) %>%
select(everything(),method)
#  names(phe_isr) <- c("method", "group", "total_count", "total_pop", "dsr",
#                      paste("lower",conf.level*100,"cl",sep=""),
#                      paste("upper",conf.level*100,"cl",sep=""))
return(phe_isr)
}
phe_isr(multiareadata$count, multiareadata$pop,
refdata$refcount, refdata$refpop,
groupref=multiareadata$area)
phe_isr <- function(x,n,ref_x, ref_n, groupref = 1, conf.level = 0.95, percentage = FALSE) {
# scale confidence level
if (conf.level >= 90) {
conf.level <- conf.level/100
}
# calculate ISR and CIs
phe_isr <- data.frame(x,n,ref_x,ref_n,groupref) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100) %>%
mutate(testlower = if_else(obs<100, qchisq((1-conf.level)/2,2*obs)/2/exp*100,
byars_lower(obs,conf.level)/exp*100),
testupper = if_else(obs<100, qchisq(conf.level+(1-conf.level)/2,2*obs+2)/2/exp*100,
byars_upper(obs,conf.level)/exp*100),
method = if_else(obs<100,"Exact","Byars")) %>%
names(phe_isr) <- c("method", "group", "observed", "expected", "isr",
paste("lower",conf.level*100,"cl",sep=""),
paste("upper",conf.level*100,"cl",sep=""))
return(phe_isr)
}
phe_isr(multiareadata$count, multiareadata$pop,
refdata$refcount, refdata$refpop,
groupref=multiareadata$area)
phe_isr <- function(x,n,ref_x, ref_n, groupref = 1, conf.level = 0.95, percentage = FALSE) {
# scale confidence level
if (conf.level >= 90) {
conf.level <- conf.level/100
}
# calculate ISR and CIs
phe_isr <- data.frame(x,n,ref_x,ref_n,groupref) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100) %>%
mutate(testlower = if_else(obs<100, qchisq((1-conf.level)/2,2*obs)/2/exp*100,
byars_lower(obs,conf.level)/exp*100),
testupper = if_else(obs<100, qchisq(conf.level+(1-conf.level)/2,2*obs+2)/2/exp*100,
byars_upper(obs,conf.level)/exp*100),
method = if_else(obs<100,"Exact","Byars")) %>%
names(phe_isr) <- c("method", "group", "observed", "expected", "isr",
paste("lower",conf.level*100,"cl",sep=""),
paste("upper",conf.level*100,"cl",sep=""))
return(phe_isr)
}
phe_isr(multiareadata$count, multiareadata$pop,
refdata$refcount, refdata$refpop,
groupref=multiareadata$area)
multiareadata$count
multiareadata$pop
refdata$refcount
refdata$refpop
groupref=multiareadata$area
View(multiareadata)
multiareadata    <- read_excel(".\\tests\\testthat\\testdata_ISR.xlsx", sheet="testdata_multiarea", col_names=TRUE)
multiareadata$area
phe_isr(multiareadata$count, multiareadata$pop,
refdata$refcount, refdata$refpop,
groupref=multiareadata$area)
View(multiareadata)
data.frame(x,n,ref_x,ref_n,groupref)
phe_isr <- data.frame(x=multiareadata$count,
n=multiareadata$pop,
ref_x=refdata$refcount,
ref_n=refdata$refpop,
groupref=multiareadata$area)
phe_isr <- data.frame(x=multiareadata$count,
n=multiareadata$pop,
ref_x=refdata$refcount,
ref_n=refdata$refpop,
groupref=multiareadata$area) %>%
mutate(exp_x = ref_x/ref_n * n)
phe_isr <- data.frame(x=multiareadata$count,
n=multiareadata$pop,
ref_x=refdata$refcount,
ref_n=refdata$refpop,
groupref=multiareadata$area) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100) %>%
mutate(testlower = if_else(obs<100, qchisq((1-conf.level)/2,2*obs)/2/exp*100,
byars_lower(obs,conf.level)/exp*100),
testupper = if_else(obs<100, qchisq(conf.level+(1-conf.level)/2,2*obs+2)/2/exp*100,
byars_upper(obs,conf.level)/exp*100),
method = if_else(obs<100,"Exact","Byars"))
phe_isr <- data.frame(x=multiareadata$count,
n=multiareadata$pop,
ref_x=refdata$refcount,
ref_n=refdata$refpop,
groupref=multiareadata$area) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * 100) %>%
mutate(testlower = if_else(obs<100, qchisq((1-0.95)/2,2*obs)/2/exp*100,
byars_lower(obs,0.95)/exp*100),
testupper = if_else(obs<100, qchisq(0.95+(1-0.95)/2,2*obs+2)/2/exp*100,
byars_upper(obs,0.95)/exp*100),
method = if_else(obs<100,"Exact","Byars"))
View(phe_isr)
phe_isr <- function(x,n,ref_x, ref_n, groupref = 1, conf.level = 0.95, percentage = FALSE) {
# scale confidence level
if (conf.level >= 90) {
conf.level <- conf.level/100
}
# set multiplier
multiplier <- 1
if (percentage == TRUE) {
multiplier <- 100
}
# calculate ISR and CIs
phe_isr <- data.frame(x,n,ref_x,ref_n,groupref) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs = sum(x),
exp = sum(exp_x),
isr = obs / exp * multiplier) %>%
mutate(testlower = if_else(obs<100, qchisq((1-conf.level)/2,2*obs)/2/exp*multiplier,
byars_lower(obs,conf.level)/exp*multiplier),
testupper = if_else(obs<100, qchisq(conf.level+(1-conf.level)/2,2*obs+2)/2/exp*multiplier,
byars_upper(obs,conf.level)/exp*multiplier),
method = if_else(obs<100,"Exact","Byars"))
names(phe_isr) <- c("method", "group", "observed", "expected", "isr",
paste("lower",conf.level*100,"cl",sep=""),
paste("upper",conf.level*100,"cl",sep=""))
return(phe_isr)
}
phe_isr(multiareadata$count, multiareadata$pop,
refdata$refcount, refdata$refpop,
groupref=multiareadata$area)
phe_isr <- function(x,n,ref_x, ref_n, groupref = 1, conf.level = 0.95, type = "ratio", percentage = FALSE, multiplier = 1) {
# scale confidence level
if (conf.level >= 90) {
conf.level <- conf.level/100
}
# calculate ISR and CIs
if (type == "ratio") {
# set multiplier
if (percentage == TRUE) {
multiplier <- 100
}
phe_isr <- data.frame(x,n,ref_x,ref_n,groupref) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs  = sum(x),
exp  = sum(exp_x),
isr  = obs / exp * multiplier) %>%
mutate(lowercl = if_else(obs<100, qchisq((1-conf.level)/2,2*obs)/2/exp*multiplier,
byars_lower(obs,conf.level)/exp*multiplier),
uppercl = if_else(obs<100, qchisq(conf.level+(1-conf.level)/2,2*obs+2)/2/exp*multiplier,
byars_upper(obs,conf.level)/exp*multiplier),
method  = if_else(obs<100,"Exact","Byars"))
names(phe_isr) <- c("group", "observed", "expected", "isr",
paste("lower",conf.level*100,"cl",sep=""),
paste("upper",conf.level*100,"cl",sep=""),"method")
}
if (type == "rate") {
phe_isr <- data.frame(x,n,ref_x,ref_n,groupref) %>%
mutate(exp_x = ref_x/ref_n * n) %>%
group_by(groupref) %>%
summarise(obs  = sum(x),
exp  = sum(exp_x),
ref_rate = sum(ref_x) / sum(ref_n) * multiplier,
isr  = obs / exp * ref_rate) %>%
mutate(lowercl = if_else(obs<100, qchisq((1-conf.level)/2,2*obs)/2/exp * ref_rate,
byars_lower(obs,conf.level)/exp * ref_rate),
uppercl = if_else(obs<100, qchisq(conf.level+(1-conf.level)/2,2*obs+2)/2/exp * ref_rate,
byars_upper(obs,conf.level)/exp * ref_rate),
method  = if_else(obs<100,"Exact","Byars"))
names(phe_isr) <- c("group", "observed", "expected", "reference rate", "isr",
paste("lower",conf.level*100,"cl",sep=""),
paste("upper",conf.level*100,"cl",sep=""),"method")
}
return(phe_isr)
}
phe_isr(multiareadata$count, multiareadata$pop,
refdata$refcount, refdata$refpop,
groupref=multiareadata$area, type="rate")
phe_isr(multiareadata$count, multiareadata$pop,
refdata$refcount, refdata$refpop,
groupref=multiareadata$area, type="rate",multiplier=100000)
